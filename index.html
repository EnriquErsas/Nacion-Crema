<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description"
        content="Nación U Crema - Tienda oficial de productos del Club Universitario de Deportes. Camisetas, accesorios y ediciones limitadas.">
    <meta name="keywords" content="Universitario, U Crema, camisetas, merchandising, Perú, fútbol">
    <meta name="supabase-url" content="https://bviefoqqzupcqbbyrpco.supabase.co">
    <meta name="supabase-anon-key" content="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ2aWVmb3FxenVwY3FiYnlycGNvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzEwOTExNTcsImV4cCI6MjA4NjY2NzE1N30.3Fw4TdKbHUWNENKKjou3Y6iU-rjKZN65BB-lhUlRDKA">
    <meta name="theme-color" content="#761C1C">
    <meta property="og:title" content="Nación U Crema - Tienda Oficial">
    <meta property="og:description" content="Productos oficiales del club más grande del Perú. Calidad premium, pasión eterna.">
    <meta property="og:type" content="website">
    <meta property="og:image" content="assets/1.jpeg">
    <link rel="icon" href="assets/1.jpeg">
    <title>Nación U Crema - Tienda Oficial | Productos Exclusivos Universitario</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Bebas+Neue&display=swap"
        rel="stylesheet">

    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        * {
            font-family: 'Inter', sans-serif;
        }

        .font-bebas {
            font-family: 'Bebas Neue', cursive;
        }

        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }

        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        @keyframes float {

            0%,
            100% {
                transform: translateY(0px);
            }

            50% {
                transform: translateY(-10px);
            }
        }

        .animate-float {
            animation: float 3s ease-in-out infinite;
        }

        .gradient-text {
            background: linear-gradient(135deg, #D4AF37 0%, #FFD700 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .hover-lift {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .hover-lift:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
        }

        html {
            scroll-behavior: smooth;
        }

        @media (prefers-reduced-motion: reduce) {
            * {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>

<body class="bg-gray-50 text-gray-900">
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;

        const getMeta = (name) => (document.querySelector(`meta[name="${name}"]`)?.content || '').trim();
        const SUPABASE_URL = getMeta('supabase-url');
        const SUPABASE_ANON_KEY = getMeta('supabase-anon-key');
        const supabaseClient = window.supabase?.createClient?.(SUPABASE_URL, SUPABASE_ANON_KEY) || null;

        const getNombreUsuario = (user) => user?.user_metadata?.nombre || user?.user_metadata?.name || user?.email?.split('@')?.[0] || 'Usuario';
        const buildSupabaseNetworkHelp = () => {
            const origin = window.location.origin;
            return [
                'No se pudo conectar con Supabase (Failed to fetch).',
                '',
                `Origen actual: ${origin}`,
                `Supabase URL: ${SUPABASE_URL || '(vacía)'}`,
                '',
                'Causas típicas:',
                '- CORS: falta agregar este dominio en Supabase (Project Settings → API → CORS → Allowed Origins).',
                '- URL/Anon Key desactualizadas (si recreaste el proyecto de Supabase).',
                '- Bloqueo del navegador/extensiones (adblock/shields) o red.',
                '',
                'Pruebas rápidas:',
                `1) Abre: ${SUPABASE_URL}/auth/v1/health (debe responder, no fallar).`,
                `2) En Supabase agrega Allowed Origins: ${origin}`,
                '3) Recarga duro (Ctrl+F5) y prueba otra vez.'
            ].join('\n');
        };
        const isFailedToFetch = (msg) => String(msg || '').toLowerCase().includes('failed to fetch');

        // Iconos SVG
        const ShoppingBag = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M6 2 3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4Z" /><path d="M3 6h18" /><path d="M16 10a4 4 0 0 1-8 0" /></svg>;
        const Menu = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><line x1="4" x2="20" y1="12" y2="12" /><line x1="4" x2="20" y1="6" y2="6" /><line x1="4" x2="20" y1="18" y2="18" /></svg>;
        const X = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M18 6 6 18" /><path d="m6 6 12 12" /></svg>;
        const Trash2 = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M3 6h18" /><path d="M19 6v14c0 1-1 2-2 2H7c-1 0-2-1-2-2V6" /><path d="M8 6V4c0-1 1-2 2-2h4c1 0 2 1 2 2v2" /><line x1="10" x2="10" y1="11" y2="17" /><line x1="14" x2="14" y1="11" y2="17" /></svg>;
        const MessageCircle = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="m3 21 1.9-5.7a8.5 8.5 0 1 1 3.8 3.8z" /></svg>;
        const TikTok = (props) => (
            <svg viewBox="0 0 24 24" aria-hidden="true" {...props}>
                <path fill="currentColor" d="M19.589 6.686a4.793 4.793 0 0 1-3.77-4.77V1h-3.813v13.803a3.316 3.316 0 0 1-3.313 3.312 3.316 3.316 0 0 1-3.313-3.312 3.316 3.316 0 0 1 3.313-3.313c.324 0 .64.047.94.13V7.75a7.09 7.09 0 0 0-.94-.062 7.115 7.115 0 1 0 7.115 7.115V9.86a8.58 8.58 0 0 0 3.77.877V6.686Z" />
            </svg>
        );
        const WhatsAppLogo = (props) => (
            <svg viewBox="0 0 24 24" aria-hidden="true" {...props}>
                <path
                    fill="currentColor"
                    d="M20.52 3.48A11.78 11.78 0 0 0 12.04 0C5.49 0 .22 5.27.22 11.78c0 2.08.54 4.1 1.57 5.9L0 24l6.46-1.69a11.8 11.8 0 0 0 5.59 1.43h.01c6.55 0 11.82-5.27 11.82-11.78 0-3.15-1.23-6.11-3.36-8.24zM12.06 21.3a9.5 9.5 0 0 1-4.85-1.33l-.35-.21-3.83 1 1.02-3.74-.23-.38a9.4 9.4 0 0 1-1.45-5.04c0-5.23 4.26-9.49 9.5-9.49 2.54 0 4.93.99 6.72 2.78a9.43 9.43 0 0 1 2.78 6.71c0 5.23-4.26 9.5-9.51 9.5zm5.22-7.14c-.28-.14-1.65-.81-1.9-.9-.26-.1-.45-.14-.64.14-.19.29-.73.9-.9 1.09-.16.19-.33.21-.61.07-.28-.14-1.2-.44-2.3-1.4-.85-.75-1.42-1.68-1.59-1.96-.16-.29-.02-.45.12-.59.12-.12.28-.33.4-.49.14-.16.19-.28.28-.47.09-.19.05-.36-.02-.5-.07-.14-.64-1.55-.88-2.12-.23-.56-.47-.48-.64-.48h-.55c-.19 0-.5.07-.76.36-.26.29-1 1-1 2.43 0 1.43 1.03 2.81 1.18 3 .14.19 2.02 3.2 4.9 4.49.69.3 1.23.48 1.65.62.69.22 1.32.19 1.82.12.56-.07 1.65-.68 1.88-1.34.23-.66.23-1.23.16-1.34-.07-.12-.26-.19-.54-.33z"
                />
            </svg>
        );
        const ChevronRight = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="m9 18 6-6-6-6" /></svg>;
        const Truck = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M14 18V6a2 2 0 0 0-2-2H4a2 2 0 0 0-2 2v11a1 1 0 0 0 1 1h2" /><path d="M15 18H9" /><circle cx="17" cy="18" r="2" /><circle cx="7" cy="18" r="2" /></svg>;
        const ShieldCheck = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M12 22s8-4 8-10V5l-8-3-8 3v7c0 6 8 10 8 10" /><path d="m9 12 2 2 4-4" /></svg>;

        const User = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M19 21v-2a4 4 0 0 0-4-4H9a4 4 0 0 0-4 4v2" /><circle cx="12" cy="7" r="4" /></svg>;
        const LogOut = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16 17 21 12 16 7" /><line x1="21" x2="9" y1="12" y2="12" /></svg>;
        const Package = (props) => <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2" {...props}><path d="M16.5 9.4 7.55 4.24" /><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z" /><polyline points="3.29 7 12 12 20.71 7" /><line x1="12" x2="12" y1="22" y2="12" /></svg>;

        const DEFAULT_PRODUCTOS = [
            { id: 1, nombre: "Camiseta Oficial 2026", precio: 99.90, categoria: "Camisetas", imagen: "assets/1.jpeg", rating: 5, reviews: 234, descripcion: "Camiseta oficial Universitario 2026. Tela premium transpirable." },
            { id: 2, nombre: "Box Estadio Monumental", precio: 79.90, categoria: "Coleccionables", imagen: "assets/2.jpeg", rating: 4.9, reviews: 156, descripcion: "Réplica en miniatura del Estadio Monumental. Edición coleccionista." },
            { id: 3, nombre: "Chanchito Crema - Peluche", precio: 39.90, categoria: "Peluches", imagen: "assets/3.jpeg", rating: 5, reviews: 89, descripcion: "Peluche oficial Chanchito Crema. Suave y adorable." },
            { id: 4, nombre: "Box Tricampeón Premium", precio: 149.90, categoria: "Ediciones Limitadas", imagen: "assets/4.jpeg", rating: 5, reviews: 312, descripcion: "Box especial Tricampeón con productos exclusivos y certificado." },
            { id: 5, nombre: "Leoncito Crema - Peluche", precio: 39.90, categoria: "Peluches", imagen: "assets/5.jpeg", rating: 4.8, reviews: 67, descripcion: "Peluche oficial Leoncito Crema. Mascota oficial del club." },
            { id: 6, nombre: "Cadena 'Dije U' - Dorada", precio: 49.90, categoria: "Accesorios", imagen: "assets/6.jpeg", rating: 4.7, reviews: 124, descripcion: "Cadena dorada con dije U. Acero inoxidable bañado en oro." },
            { id: 7, nombre: "Cadena 'Dije U' - Plateada", precio: 49.90, categoria: "Accesorios", imagen: "assets/7.jpeg", rating: 4.7, reviews: 98, descripcion: "Cadena plateada con dije U. Acero inoxidable premium." },
            { id: 8, nombre: "Chocolate Ferrero Rocher", precio: 9.90, categoria: "Extras", imagen: "assets/8.jpeg", rating: 5, reviews: 45, descripcion: "Agrega un detalle dulce a tu pedido. Pack de 3 unidades." }
        ];

        const normalizeProducto = (row) => {
            const rawPrecio = row?.precio ?? row?.price ?? row?.amount ?? 0;
            const precio = typeof rawPrecio === 'number' ? rawPrecio : Number(rawPrecio);
            return {
                id: row?.id ?? row?.product_id ?? row?.uuid ?? String(Math.random()),
                nombre: row?.nombre ?? row?.name ?? row?.title ?? 'Producto',
                precio: Number.isFinite(precio) ? precio : 0,
                categoria: row?.categoria ?? row?.category ?? row?.tipo ?? 'Otros',
                imagen: row?.imagen ?? row?.image ?? row?.image_url ?? row?.imagen_url ?? 'assets/1.jpeg',
                rating: row?.rating ?? 5,
                reviews: row?.reviews ?? row?.review_count ?? 0,
                descripcion: row?.descripcion ?? row?.description ?? ''
            };
        };

        function App() {
            const [vista, setVista] = useState('inicio');
            const [carrito, setCarrito] = useState([]);
            const [productoSeleccionado, setProductoSeleccionado] = useState(null);
            const [menuAbierto, setMenuAbierto] = useState(false);
            const [filtroCategoria, setFiltroCategoria] = useState('Todos');

            const [usuario, setUsuario] = useState(null);
            const [mostrarAuth, setMostrarAuth] = useState(false);
            const [modoAuth, setModoAuth] = useState('login');
            const [formData, setFormData] = useState({ nombre: '', celular: '', email: '', password: '', password2: '' });
            const [authCargando, setAuthCargando] = useState(false);
            const [pedidosUsuario, setPedidosUsuario] = useState([]);
            const [pedidosCargando, setPedidosCargando] = useState(false);
            const [pedidosError, setPedidosError] = useState('');
            const [pedidosYape, setPedidosYape] = useState([]);
            const [pedidosYapeCargando, setPedidosYapeCargando] = useState(false);
            const [pedidosYapeError, setPedidosYapeError] = useState('');
            const [pedidoCreando, setPedidoCreando] = useState(false);
            const [checkoutData, setCheckoutData] = useState({ nombre: '', whatsapp: '', archivo: null });
            const [checkoutCargando, setCheckoutCargando] = useState(false);
            const [checkoutOk, setCheckoutOk] = useState(null);
            const [checkoutErrors, setCheckoutErrors] = useState({ nombre: '', whatsapp: '', archivo: '' });
            const [adminCargando, setAdminCargando] = useState(false);
            const [esAdmin, setEsAdmin] = useState(false);
            const [adminPedidos, setAdminPedidos] = useState([]);
            const [adminPedidosCargando, setAdminPedidosCargando] = useState(false);
            const [adminPedidosError, setAdminPedidosError] = useState('');
            const [adminImagen, setAdminImagen] = useState(null);
            const [adminFiltroEstado, setAdminFiltroEstado] = useState('todos');
            const [adminBusqueda, setAdminBusqueda] = useState('');
            const [adminOrdenFecha, setAdminOrdenFecha] = useState('desc');
            const [adminDetalle, setAdminDetalle] = useState(null);
            const [adminHistorial, setAdminHistorial] = useState([]);
            const [adminHistorialCargando, setAdminHistorialCargando] = useState(false);
            const [adminHistorialError, setAdminHistorialError] = useState('');
            const [productos, setProductos] = useState(DEFAULT_PRODUCTOS);
            const [productosOrigen, setProductosOrigen] = useState('demo');
            const [cargandoProductos, setCargandoProductos] = useState(false);
            const [authErrors, setAuthErrors] = useState({ nombre: '', celular: '', email: '', password: '' });
            const [otpState, setOtpState] = useState({ email: '', codigo: '' });
            const [resetState, setResetState] = useState({ password: '', password2: '' });
            const [otpError, setOtpError] = useState('');
            const [resetError, setResetError] = useState('');
            const [registroPendiente, setRegistroPendiente] = useState({ email: '', password: '' });
            const [adminSetupCode, setAdminSetupCode] = useState('');
            const [adminSetupMostrar, setAdminSetupMostrar] = useState(false);
            const [adminSetupCargando, setAdminSetupCargando] = useState(false);
            const [adminSetupOk, setAdminSetupOk] = useState('');
            const [adminSetupErr, setAdminSetupErr] = useState('');

            const adminPedidosFiltrados = useMemo(() => {
                const base = Array.isArray(adminPedidos) ? [...adminPedidos] : [];
                const q = String(adminBusqueda || '').trim().toLowerCase();
                const estado = String(adminFiltroEstado || 'todos').toLowerCase();
                const filtrados = base.filter((p) => {
                    if (estado !== 'todos' && String(p?.estado || '').toLowerCase() !== estado) return false;
                    if (!q) return true;
                    const parts = [
                        String(p?.id || ''),
                        String(p?.cliente_nombre || ''),
                        String(p?.cliente_whatsapp || ''),
                        String(p?.estado || '')
                    ].map((x) => x.toLowerCase());
                    return parts.some((x) => x.includes(q));
                });
                filtrados.sort((a, b) => {
                    const da = a?.created_at ? new Date(a.created_at).getTime() : 0;
                    const db = b?.created_at ? new Date(b.created_at).getTime() : 0;
                    return adminOrdenFecha === 'asc' ? da - db : db - da;
                });
                return filtrados;
            }, [adminPedidos, adminBusqueda, adminFiltroEstado, adminOrdenFecha]);

            useEffect(() => {
                if (!supabaseClient) return;
                supabaseClient.auth.getSession().then(({ data }) => {
                    setUsuario(data?.session?.user ?? null);
                });
                const { data: authListener } = supabaseClient.auth.onAuthStateChange((_event, session) => {
                    setUsuario(session?.user ?? null);
                });
                return () => {
                    authListener?.subscription?.unsubscribe?.();
                };
            }, []);

            const recargarPedidos = async () => {
                if (!supabaseClient || !usuario) {
                    setPedidosUsuario([]);
                    return;
                }
                setPedidosCargando(true);
                setPedidosError('');
                const { data, error } = await supabaseClient
                    .from('orders')
                    .select('id, created_at, estado, total, order_items ( cantidad, precio_unitario, products ( nombre ) )')
                    .order('created_at', { ascending: false });
                if (error) {
                    setPedidosError(error.message || 'No se pudieron cargar los pedidos');
                    setPedidosUsuario([]);
                    setPedidosCargando(false);
                    return;
                }
                setPedidosUsuario(Array.isArray(data) ? data : []);
                setPedidosCargando(false);
            };

            const recargarPedidosYape = async () => {
                if (!supabaseClient || !usuario) {
                    setPedidosYape([]);
                    return;
                }
                setPedidosYapeCargando(true);
                setPedidosYapeError('');
                const baseSelect = 'id, created_at, estado, total, comprobante_url, items, cliente_nombre, cliente_whatsapp, user_id';
                const userId = usuario?.id;
                const celular = normalizarWhatsapp(usuario?.user_metadata?.celular || '');

                let data = null;
                let error = null;

                if (userId) {
                    ({ data, error } = await supabaseClient
                        .from('pedidos')
                        .select(baseSelect)
                        .eq('user_id', userId)
                        .order('created_at', { ascending: false }));
                }

                if (error && String(error.message || '').toLowerCase().includes('user_id')) {
                    error = null;
                    data = null;
                }

                if (!error && (!Array.isArray(data) || data.length === 0) && celular) {
                    const r = await supabaseClient
                        .from('pedidos')
                        .select(baseSelect)
                        .eq('cliente_whatsapp', celular)
                        .order('created_at', { ascending: false });
                    data = r.data;
                    error = r.error;
                }

                if (error) {
                    setPedidosYapeError(error.message || 'No se pudieron cargar los pedidos');
                    setPedidosYape([]);
                    setPedidosYapeCargando(false);
                    return;
                }

                setPedidosYape(Array.isArray(data) ? data : []);
                setPedidosYapeCargando(false);
            };

            useEffect(() => {
                if (!supabaseClient || !usuario) {
                    setPedidosUsuario([]);
                    setPedidosYape([]);
                    return;
                }
                let cancelado = false;
                (async () => {
                    await recargarPedidos();
                    await recargarPedidosYape();
                })();
                return () => {
                    cancelado = true;
                };
            }, [usuario?.id]);

            useEffect(() => {
                if (!supabaseClient) return;
                let cancelado = false;
                (async () => {
                    setCargandoProductos(true);
                    const { data, error } = await supabaseClient.from('products').select('*').order('id', { ascending: true });
                    if (cancelado) return;
                    if (error || !Array.isArray(data) || data.length === 0) {
                        setProductos(DEFAULT_PRODUCTOS);
                        setProductosOrigen('demo');
                        setCargandoProductos(false);
                        return;
                    }
                    setProductos(data.map(normalizeProducto));
                    setProductosOrigen('supabase');
                    setCargandoProductos(false);
                })();
                return () => {
                    cancelado = true;
                };
            }, []);

            const handleLogin = async (e) => {
                e.preventDefault();
                if (!supabaseClient) {
                    alert('No se pudo iniciar sesión: falta configuración de Supabase.');
                    return;
                }
                const emailError = validarEmail(formData.email);
                const passwordError = validarPassword(formData.password);
                const nextErrors = { ...authErrors, email: emailError, password: passwordError };
                setAuthErrors(nextErrors);
                if (emailError || passwordError) return;
                setAuthCargando(true);
                try {
                    const { data, error } = await supabaseClient.auth.signInWithPassword({
                        email: formData.email,
                        password: formData.password
                    });
                    if (error) {
                        if (isFailedToFetch(error.message)) {
                            alert(buildSupabaseNetworkHelp());
                        } else {
                            alert(error.message || 'Credenciales incorrectas');
                        }
                        return;
                    }
                    if (data?.user) {
                        setMostrarAuth(false);
                        setFormData({ nombre: '', celular: '', email: '', password: '', password2: '' });
                        setAuthErrors({ nombre: '', celular: '', email: '', password: '' });
                    }
                } catch (_err) {
                    alert('No se pudo conectar con Supabase (CORS o red). Revisa la configuración de Allowed Origins y tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const handleRegistro = async (e) => {
                e.preventDefault();
                if (!supabaseClient) {
                    alert('No se pudo registrar: falta configuración de Supabase.');
                    return;
                }
                const nombreError = validarNombre(formData.nombre);
                const celularError = validarCelular(formData.celular);
                const emailError = validarEmail(formData.email);
                const passwordError = validarPassword(formData.password);
                const password2Error = formData.password !== formData.password2 ? 'Las contraseñas no coinciden' : '';
                const nextErrors = { nombre: nombreError, celular: celularError, email: emailError, password: passwordError || password2Error };
                setAuthErrors(nextErrors);
                if (nombreError || celularError || emailError || passwordError || password2Error) return;
                setAuthCargando(true);
                try {
                    const email = formData.email.trim().toLowerCase();
                    const { data: yaExiste, error: existsError } = await supabaseClient.rpc('email_exists', { p_email: email });
                    if (!existsError && yaExiste === true) {
                        setAuthErrors({ ...nextErrors, email: 'Ya existe una cuenta con este correo. Inicia sesión.' });
                        setModoAuth('login');
                        setFormData({ nombre: '', celular: '', email, password: '', password2: '' });
                        return;
                    }
                    const { error } = await enviarCodigoEmail({
                        email,
                        data: { nombre: formData.nombre.trim(), celular: normalizarWhatsapp(formData.celular) },
                        shouldCreateUser: true
                    });
                    if (error) {
                        if (isFailedToFetch(error.message)) {
                            alert(buildSupabaseNetworkHelp());
                        } else {
                            alert(error.message || 'No se pudo crear la cuenta');
                        }
                        return;
                    }
                    setRegistroPendiente({ email: formData.email.trim(), password: formData.password });
                    setOtpState({ email: formData.email.trim(), codigo: '' });
                    setOtpError('');
                    setModoAuth('registro_codigo');
                } catch (_err) {
                    alert('No se pudo conectar con Supabase (CORS o red). Revisa la configuración de Allowed Origins y tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const verificarCodigoRegistro = async (e) => {
                e.preventDefault();
                if (!supabaseClient) return;
                const email = String(otpState.email || '').trim();
                const codigo = String(otpState.codigo || '').trim();
                if (!email) {
                    setOtpError('Falta el email');
                    return;
                }
                if (!codigo || codigo.length < 4) {
                    setOtpError('Ingresa el código que llegó a tu correo');
                    return;
                }
                setAuthCargando(true);
                setOtpError('');
                try {
                    const { error } = await verificarCodigoEmail({ email, codigo, tipoPreferido: 'signup' });
                    if (error) {
                        setOtpError(error.message || 'Código inválido');
                        return;
                    }
                    const passError = validarPassword(registroPendiente.password);
                    if (passError) {
                        setOtpError(passError);
                        return;
                    }
                    const { error: passSetError } = await supabaseClient.auth.updateUser({ password: registroPendiente.password });
                    if (passSetError) {
                        const msg = String(passSetError.message || '');
                        if (msg.toLowerCase().includes('different from the old password')) {
                            setOtpError('Ya existe una cuenta con este correo. Inicia sesión o recupera tu contraseña.');
                            setModoAuth('login');
                            setOtpState({ email: '', codigo: '' });
                            setRegistroPendiente({ email: '', password: '' });
                            return;
                        }
                        setOtpError(msg || 'No se pudo guardar la contraseña');
                        return;
                    }
                    setMostrarAuth(false);
                    setModoAuth('login');
                    setFormData({ nombre: '', celular: '', email: '', password: '', password2: '' });
                    setAuthErrors({ nombre: '', celular: '', email: '', password: '' });
                    setOtpState({ email: '', codigo: '' });
                    setRegistroPendiente({ email: '', password: '' });
                } catch (_err) {
                    setOtpError('No se pudo verificar el código. Revisa tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const enviarCodigoRecuperacion = async (e) => {
                e.preventDefault();
                if (!supabaseClient) return;
                const emailError = validarEmail(formData.email);
                setAuthErrors({ ...authErrors, email: emailError });
                if (emailError) return;
                setAuthCargando(true);
                try {
                    const email = formData.email.trim();
                    const { error } = await enviarCodigoEmail({ email, data: {}, shouldCreateUser: false });
                    if (error) {
                        setOtpError(error.message || 'No se pudo enviar el código');
                        return;
                    }
                    setOtpState({ email, codigo: '' });
                    setOtpError('');
                    setResetState({ password: '', password2: '' });
                    setResetError('');
                    setModoAuth('forgot_codigo');
                } catch (_err) {
                    setOtpError('No se pudo enviar el código. Revisa tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const verificarCodigoRecuperacion = async (e) => {
                e.preventDefault();
                if (!supabaseClient) return;
                const email = String(otpState.email || '').trim();
                const codigo = String(otpState.codigo || '').trim();
                if (!email) {
                    setOtpError('Falta el email');
                    return;
                }
                if (!codigo || codigo.length < 4) {
                    setOtpError('Ingresa el código que llegó a tu correo');
                    return;
                }
                setAuthCargando(true);
                setOtpError('');
                try {
                    const { error } = await verificarCodigoEmail({ email, codigo, tipoPreferido: 'email' });
                    if (error) {
                        setOtpError(error.message || 'Código inválido');
                        return;
                    }
                    setModoAuth('reset_password');
                } catch (_err) {
                    setOtpError('No se pudo verificar el código. Revisa tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const actualizarPassword = async (e) => {
                e.preventDefault();
                if (!supabaseClient) return;
                const passError = validarPassword(resetState.password);
                const pass2Error = resetState.password !== resetState.password2 ? 'Las contraseñas no coinciden' : '';
                const err = passError || pass2Error;
                setResetError(err);
                if (err) return;
                setAuthCargando(true);
                try {
                    const { error } = await supabaseClient.auth.updateUser({ password: resetState.password });
                    if (error) {
                        setResetError(error.message || 'No se pudo actualizar la contraseña');
                        return;
                    }
                    setMostrarAuth(false);
                    setModoAuth('login');
                    setFormData({ nombre: '', celular: '', email: '', password: '', password2: '' });
                    setAuthErrors({ nombre: '', celular: '', email: '', password: '' });
                    setOtpState({ email: '', codigo: '' });
                    setResetState({ password: '', password2: '' });
                    setOtpError('');
                    setResetError('');
                } catch (_err) {
                    setResetError('No se pudo actualizar la contraseña. Revisa tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const getTituloAuth = () => {
                if (modoAuth === 'login') return 'INICIAR SESIÓN';
                if (modoAuth === 'registro') return 'CREAR CUENTA';
                if (modoAuth === 'registro_codigo') return 'VERIFICAR CÓDIGO';
                if (modoAuth === 'forgot_email') return 'RECUPERAR CONTRASEÑA';
                if (modoAuth === 'forgot_codigo') return 'VERIFICAR CÓDIGO';
                if (modoAuth === 'reset_password') return 'NUEVA CONTRASEÑA';
                return 'INICIAR SESIÓN';
            };

            const handleAuthSubmit = (e) => {
                if (modoAuth === 'login') return handleLogin(e);
                if (modoAuth === 'registro') return handleRegistro(e);
                if (modoAuth === 'registro_codigo') return verificarCodigoRegistro(e);
                if (modoAuth === 'forgot_email') return enviarCodigoRecuperacion(e);
                if (modoAuth === 'forgot_codigo') return verificarCodigoRecuperacion(e);
                if (modoAuth === 'reset_password') return actualizarPassword(e);
                return handleLogin(e);
            };

            const reenviarCodigoOtp = async () => {
                if (!supabaseClient) return;
                const email = String(otpState.email || '').trim();
                if (!email) {
                    setOtpError('Falta el email');
                    return;
                }
                setAuthCargando(true);
                setOtpError('');
                try {
                    const { error } = await enviarCodigoEmail({ email, data: {}, shouldCreateUser: modoAuth === 'registro_codigo' });
                    if (error) {
                        setOtpError(error.message || 'No se pudo reenviar el código');
                        return;
                    }
                } catch (_err) {
                    setOtpError('No se pudo reenviar el código. Revisa tu conexión.');
                } finally {
                    setAuthCargando(false);
                }
            };

            const activarAdminConCodigo = async () => {
                if (!supabaseClient || !usuario?.id) return;
                setAdminSetupOk('');
                setAdminSetupErr('');
                const email = String(usuario?.email || '').trim().toLowerCase();
                if (email !== 'loarojas3@gmail.com') {
                    setAdminSetupErr('Acción no permitida');
                    return;
                }
                const code = String(adminSetupCode || '').trim();
                if (code.length < 6) {
                    setAdminSetupErr('Ingresa tu código de administrador');
                    return;
                }
                setAdminSetupCargando(true);
                try {
                    const { error } = await supabaseClient.rpc('grant_admin', { setup_code: code });
                    if (error) {
                        setAdminSetupErr(error.message || 'No se pudo activar admin');
                        return;
                    }
                    setEsAdmin(true);
                    setAdminSetupOk('Admin activado');
                    setAdminSetupCode('');
                } catch (_err) {
                    setAdminSetupErr('No se pudo activar admin. Revisa tu conexión.');
                } finally {
                    setAdminSetupCargando(false);
                }
            };

            const handleLogout = async () => {
                if (supabaseClient) {
                    await supabaseClient.auth.signOut();
                }
                setVista('inicio');
            };

            const categorias = useMemo(() => {
                const set = new Set((productos || []).map(p => p?.categoria).filter(Boolean));
                return ['Todos', ...Array.from(set)];
            }, [productos]);

            useEffect(() => {
                const path = window.location.pathname || '/';
                if (path.startsWith('/admin')) {
                    setVista('admin');
                }
            }, []);

            useEffect(() => {
                const hash = String(window.location.hash || '');
                const search = String(window.location.search || '');
                const hp = new URLSearchParams(hash.replace(/^#/, ''));
                const sp = new URLSearchParams(search.replace(/^\?/, ''));
                const errorCode = hp.get('error_code') || sp.get('error_code') || '';
                const errorDesc = hp.get('error_description') || sp.get('error_description') || '';
                if (!errorCode) return;
                if (errorCode === 'otp_expired') {
                    alert('El enlace del correo expiró o ya fue usado. Vuelve a la web, solicita un nuevo código y escríbelo en la pantalla de verificación.');
                    setMostrarAuth(true);
                    setModoAuth('login');
                } else {
                    alert(`Error de autenticación: ${errorDesc || errorCode}`);
                }
                window.history.replaceState({}, '', window.location.pathname);
            }, []);

            useEffect(() => {
                if (!supabaseClient) return;
                const hash = String(window.location.hash || '');
                const search = String(window.location.search || '');
                const hp = new URLSearchParams(hash.replace(/^#/, ''));
                const sp = new URLSearchParams(search.replace(/^\?/, ''));

                const type = (hp.get('type') || sp.get('type') || '').toLowerCase();
                const code = sp.get('code');
                const hasAccessToken = !!hp.get('access_token');
                const hasTokenHash = !!sp.get('token_hash') || !!hp.get('token_hash');

                if (type !== 'recovery') return;

                (async () => {
                    if (code) {
                        await supabaseClient.auth.exchangeCodeForSession(code);
                    }
                    if (hasAccessToken || hasTokenHash || code) {
                        setMostrarAuth(true);
                        setModoAuth('reset_password');
                        setResetState({ password: '', password2: '' });
                        setResetError('');
                    }
                    window.history.replaceState({}, '', window.location.pathname);
                })();
            }, []);

            useEffect(() => {
                const nextPath = vista === 'admin' ? '/admin' : '/';
                if (window.location.pathname !== nextPath) {
                    window.history.pushState({}, '', nextPath);
                }
            }, [vista]);

            useEffect(() => {
                if (!supabaseClient || !usuario?.id) {
                    setEsAdmin(false);
                    return;
                }
                let cancelado = false;
                (async () => {
                    setAdminCargando(true);
                    const { data, error } = await supabaseClient.from('admins').select('user_id').eq('user_id', usuario.id).limit(1);
                    if (cancelado) return;
                    setEsAdmin(!error && Array.isArray(data) && data.length > 0);
                    setAdminCargando(false);
                })();
                return () => {
                    cancelado = true;
                };
            }, [usuario?.id]);

            const normalizarWhatsapp = (value) => String(value || '').replace(/[^\d]/g, '').slice(0, 9);
            const normalizarNombreSoloLetras = (value) => String(value || '').replace(/[^a-zA-ZÁÉÍÓÚÜÑáéíóúüñ\s]/g, '').replace(/\s+/g, ' ').slice(0, 60);
            const validarNombre = (value) => {
                const v = String(value || '').trim();
                if (!v) return 'Ingresa tu nombre';
                if (v.length < 2) return 'El nombre debe tener al menos 2 caracteres';
                return '';
            };
            const validarWhatsapp = (value) => {
                const v = normalizarWhatsapp(value);
                if (!v) return 'Ingresa tu WhatsApp';
                if (v.length !== 9) return 'El WhatsApp debe tener 9 dígitos';
                return '';
            };
            const validarEmail = (value) => {
                const v = String(value || '').trim();
                if (!v) return 'Ingresa tu email';
                const ok = /^[^\s@]+@[^\s@]+\.[^\s@]+$/.test(v);
                return ok ? '' : 'Ingresa un email válido';
            };
            const validarPassword = (value) => {
                const v = String(value || '');
                if (!v) return 'Ingresa tu contraseña';
                if (v.length < 6) return 'La contraseña debe tener al menos 6 caracteres';
                return '';
            };
            const validarCelular = (value) => {
                const v = normalizarWhatsapp(value);
                if (!v) return 'Ingresa tu celular';
                if (v.length !== 9) return 'El celular debe tener 9 dígitos';
                return '';
            };
            const validarImagen = (file) => {
                if (!file) return { ok: false, error: 'Debes subir una imagen' };
                if (!['image/jpeg', 'image/png'].includes(file.type)) return { ok: false, error: 'Solo se permiten imágenes JPG o PNG' };
                if (file.size > 2 * 1024 * 1024) return { ok: false, error: 'La imagen no puede superar 2MB' };
                return { ok: true, error: '' };
            };
            const uuidv4 = () => {
                const g = typeof crypto !== 'undefined' && crypto?.getRandomValues ? crypto : null;
                if (g && typeof crypto.randomUUID === 'function') return crypto.randomUUID();
                const bytes = new Uint8Array(16);
                if (g) {
                    g.getRandomValues(bytes);
                } else {
                    for (let i = 0; i < 16; i++) bytes[i] = Math.floor(Math.random() * 256);
                }
                bytes[6] = (bytes[6] & 0x0f) | 0x40;
                bytes[8] = (bytes[8] & 0x3f) | 0x80;
                const hex = Array.from(bytes).map(b => b.toString(16).padStart(2, '0')).join('');
                return `${hex.slice(0, 8)}-${hex.slice(8, 12)}-${hex.slice(12, 16)}-${hex.slice(16, 20)}-${hex.slice(20)}`;
            };
            const parseItems = (value) => {
                if (!value) return [];
                if (Array.isArray(value)) return value;
                if (typeof value === 'string') {
                    try {
                        const parsed = JSON.parse(value);
                        return Array.isArray(parsed) ? parsed : [];
                    } catch (_err) {
                        return [];
                    }
                }
                return [];
            };

            const enviarCodigoEmail = async ({ email, data, shouldCreateUser }) => {
                const { error } = await supabaseClient.auth.signInWithOtp({
                    email,
                    options: { shouldCreateUser, data }
                });
                return { error };
            };

            const verificarCodigoEmail = async ({ email, codigo, tipoPreferido }) => {
                const tipos = [tipoPreferido, 'signup', 'email', 'magiclink'].filter(Boolean);
                let lastError = null;
                for (const type of tipos) {
                    try {
                        const { data, error } = await supabaseClient.auth.verifyOtp({ email, token: codigo, type });
                        if (!error) return { data, error: null };
                        lastError = error;
                    } catch (err) {
                        lastError = err;
                    }
                }
                return { data: null, error: lastError || new Error('No se pudo verificar el código') };
            };

            const crearPedidoYape = async () => {
                if (!supabaseClient) {
                    alert('No se pudo crear el pedido: falta configuración de Supabase.');
                    return;
                }
                if (carrito.length === 0) return;

                const nombreError = validarNombre(checkoutData.nombre);
                const whatsappError = validarWhatsapp(checkoutData.whatsapp);
                const imgValid = validarImagen(checkoutData.archivo);
                const archivoError = imgValid.ok ? '' : imgValid.error;
                const nextErrors = { nombre: nombreError, whatsapp: whatsappError, archivo: archivoError };
                setCheckoutErrors(nextErrors);
                if (nombreError || whatsappError || archivoError) return;

                const whatsapp = normalizarWhatsapp(checkoutData.whatsapp);
                setCheckoutCargando(true);
                try {
                    const safeName = String(checkoutData.archivo.name || 'comprobante').replace(/[^\w.\-]+/g, '_');
                    const path = `vouchers/${Date.now()}_${safeName}`;
                    const { error: uploadError } = await supabaseClient.storage.from('comprobantes').upload(path, checkoutData.archivo, { upsert: false });
                    if (uploadError) {
                        alert(uploadError.message || 'No se pudo subir el comprobante');
                        return;
                    }
                    const { data: pub } = supabaseClient.storage.from('comprobantes').getPublicUrl(path);
                    const comprobanteUrl = pub?.publicUrl || '';
                    if (!comprobanteUrl) {
                        alert('No se pudo obtener la URL del comprobante');
                        return;
                    }

                    const pedidoId = uuidv4();
                    let pedidoError = null;
                    const items = carrito.map(i => ({
                        id: i.id,
                        nombre: i.nombre,
                        cantidad: Number(i.cantidad) || 0,
                        precio: Number(i.precio) || 0
                    }));
                    const payload = {
                        id: pedidoId,
                        cliente_nombre: checkoutData.nombre.trim(),
                        cliente_whatsapp: whatsapp,
                        user_id: usuario?.id || null,
                        total: totalCarrito,
                        comprobante_url: comprobanteUrl,
                        items,
                        estado: 'pendiente'
                    };

                    ({ error: pedidoError } = await supabaseClient.from('pedidos').insert(payload, { returning: 'minimal' }));

                    if (pedidoError && String(pedidoError.message || '').toLowerCase().includes('user_id')) {
                        const { user_id, ...withoutUserId } = payload;
                        ({ error: pedidoError } = await supabaseClient.from('pedidos').insert(withoutUserId, { returning: 'minimal' }));
                    }

                    if (pedidoError) {
                        alert(pedidoError.message || 'No se pudo guardar el pedido');
                        return;
                    }

                    setCheckoutOk({ id: pedidoId, estado: 'pendiente', comprobante_url: comprobanteUrl });
                    setCheckoutErrors({ nombre: '', whatsapp: '', archivo: '' });
                    if (usuario?.id) {
                        await recargarPedidosYape();
                    }
                    setCarrito([]);
                    const resumen = carrito.map(i => `- ${i.nombre} x${i.cantidad}`).join('\n');
                    const mensaje = `Hola Nación U Crema, realicé el pago por Yape y adjunté mi comprobante. Pedido: ${pedidoId}\n\n${resumen}\n\nTotal: S/ ${Number(totalCarrito).toFixed(2)}\n\nMi WhatsApp: ${whatsapp}`;
                    window.open(`https://wa.me/51937595257?text=${encodeURIComponent(mensaje)}`, '_blank');
                } catch (_err) {
                    alert(buildSupabaseNetworkHelp());
                } finally {
                    setCheckoutCargando(false);
                }
            };

            const cargarPedidosAdmin = async () => {
                if (!supabaseClient) return;
                setAdminPedidosCargando(true);
                setAdminPedidosError('');
                const { data, error } = await supabaseClient.from('pedidos').select('*').order('created_at', { ascending: false });
                if (error) {
                    setAdminPedidosError(error.message || 'No se pudieron cargar los pedidos');
                    setAdminPedidos([]);
                    setAdminPedidosCargando(false);
                    return;
                }
                setAdminPedidos(Array.isArray(data) ? data : []);
                setAdminPedidosCargando(false);
            };

            const confirmarPago = async (pedidoId) => {
                if (!supabaseClient) return;
                const { error } = await supabaseClient.from('pedidos').update({ estado: 'pagado' }).eq('id', pedidoId);
                if (error) {
                    alert(error.message || 'No se pudo confirmar el pago');
                    return;
                }
                setAdminPedidos(adminPedidos.map(p => (p.id === pedidoId ? { ...p, estado: 'pagado' } : p)));
            };

            const abrirDetalleAdmin = async (pedido) => {
                if (!supabaseClient) return;
                setAdminDetalle(pedido);
                setAdminHistorial([]);
                setAdminHistorialError('');
                setAdminHistorialCargando(true);
                try {
                    const selectCols = 'id, created_at, estado, total, comprobante_url, cliente_nombre, cliente_whatsapp, user_id, items';
                    let q = null;
                    if (pedido?.user_id) {
                        q = supabaseClient.from('pedidos').select(selectCols).eq('user_id', pedido.user_id);
                    } else {
                        q = supabaseClient.from('pedidos').select(selectCols).eq('cliente_whatsapp', normalizarWhatsapp(pedido?.cliente_whatsapp || ''));
                    }
                    const { data, error } = await q.order('created_at', { ascending: false });
                    if (error) {
                        setAdminHistorialError(error.message || 'No se pudo cargar el historial');
                        setAdminHistorial([]);
                        return;
                    }
                    setAdminHistorial(Array.isArray(data) ? data : []);
                } finally {
                    setAdminHistorialCargando(false);
                }
            };

            const crearPedidoEnSupabase = async () => {
                if (!usuario) {
                    alert('Debes iniciar sesión para realizar un pedido');
                    setMostrarAuth(true);
                    return null;
                }
                if (!supabaseClient) {
                    alert('No se pudo crear el pedido: falta configuración de Supabase.');
                    return null;
                }
                if (carrito.length === 0) return null;

                const carritoSnapshot = carrito.map(i => ({ ...i }));
                const totalSnapshot = totalCarrito;

                setPedidoCreando(true);
                try {
                    const { data: pedido, error: pedidoError } = await supabaseClient
                        .from('orders')
                        .insert({ user_id: usuario.id, total: totalSnapshot, estado: 'Pendiente' })
                        .select('id, created_at, estado, total')
                        .single();
                    if (pedidoError) {
                        alert(pedidoError.message || 'No se pudo crear el pedido');
                        return null;
                    }
                    const payloadItems = carritoSnapshot.map(item => ({
                        order_id: pedido.id,
                        product_id: item.id,
                        cantidad: item.cantidad,
                        precio_unitario: item.precio
                    }));
                    const { error: itemsError } = await supabaseClient.from('order_items').insert(payloadItems);
                    if (itemsError) {
                        alert(itemsError.message || 'No se pudieron guardar los productos del pedido');
                        return null;
                    }
                    await recargarPedidos();
                    setCarrito([]);
                    const resumen = carritoSnapshot
                        .map(i => `- ${i.nombre} x${i.cantidad} (S/ ${(i.precio * i.cantidad).toFixed(2)})`)
                        .join('\n');
                    const mensaje = `Hola Nación U Crema, acabo de generar mi pedido #${pedido.id}.\n\n${resumen}\n\nTotal: S/ ${totalSnapshot.toFixed(2)}`;
                    window.open(`https://wa.me/51937595257?text=${encodeURIComponent(mensaje)}`, '_blank');
                    return pedido;
                } catch (_err) {
                    alert(buildSupabaseNetworkHelp());
                    return null;
                } finally {
                    setPedidoCreando(false);
                }
            };

            const agregarAlCarrito = (producto) => {
                const existe = carrito.find(item => item.id === producto.id);
                if (existe) {
                    setCarrito(carrito.map(item => item.id === producto.id ? { ...item, cantidad: item.cantidad + 1 } : item));
                } else {
                    setCarrito([...carrito, { ...producto, cantidad: 1 }]);
                }
            };

            const eliminarDelCarrito = (id) => setCarrito(carrito.filter(item => item.id !== id));
            const totalCarrito = carrito.reduce((acc, item) => acc + (item.precio * item.cantidad), 0);
            const itemsEnCarrito = carrito.reduce((acc, item) => acc + item.cantidad, 0);

            const irAProducto = (producto) => { setProductoSeleccionado(producto); setVista('producto'); window.scrollTo(0, 0); };
            const irACatalogo = (cat = 'Todos') => { setFiltroCategoria(cat); setVista('catalogo'); setMenuAbierto(false); window.scrollTo(0, 0); };

            const Header = () => (
                <header className="fixed top-0 w-full z-50 bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-[#FDFBD4] shadow-2xl">
                    <div className="container mx-auto px-4 h-16 flex items-center justify-between">
                        <button className="md:hidden" aria-label={menuAbierto ? "Cerrar menú" : "Abrir menú"} onClick={() => setMenuAbierto(!menuAbierto)}>
                            {menuAbierto ? <X size={28} /> : <Menu size={28} />}
                        </button>
                        <div className="text-2xl font-black font-bebas tracking-wider cursor-pointer" onClick={() => setVista('inicio')}>
                            <span className="gradient-text">NACIÓN</span> U CREMA
                        </div>
                        <div className="flex items-center gap-4">
                            {usuario ? (
                                <>
                                    <div className="flex items-center gap-2">
                                        <User size={28} />
                                        <span className="hidden md:block font-bold text-sm">{getNombreUsuario(usuario)}</span>
                                    </div>
                                    <button onClick={() => setVista('perfil')} className="flex items-center gap-2 bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full font-black text-sm">
                                        <Package size={16} /> <span className="hidden md:inline">Mis Pedidos</span>
                                    </button>
                                </>
                            ) : (
                                <button onClick={() => setMostrarAuth(true)} className="flex items-center gap-2 hover:scale-110 transition-transform" aria-label="Ingresar o registrarse">
                                    <User size={28} />
                                    <span className="hidden md:block font-bold text-sm">Ingresar</span>
                                </button>
                            )}
                            {esAdmin && (
                                <button onClick={() => { setVista('admin'); cargarPedidosAdmin(); }} className="hidden md:block bg-white/10 hover:bg-white/20 px-4 py-2 rounded-full font-black text-sm">
                                    Admin
                                </button>
                            )}
                            <div className="relative cursor-pointer group" role="button" tabIndex={0} aria-label="Abrir carrito" onClick={() => setVista('carrito')} onKeyDown={(e) => e.key === 'Enter' && setVista('carrito')}>
                                <ShoppingBag size={28} className="group-hover:scale-110 transition-transform" />
                                {itemsEnCarrito > 0 && (
                                    <span className="absolute -top-1 -right-1 bg-[#D4AF37] text-[#761C1C] text-xs font-bold rounded-full h-5 w-5 flex items-center justify-center animate-bounce">
                                        {itemsEnCarrito}
                                    </span>
                                )}
                            </div>
                            {usuario && (
                                <button onClick={handleLogout} className="flex items-center gap-2 bg-black/10 hover:bg-black/20 px-3 py-2 rounded-full font-black text-sm" aria-label="Cerrar sesión">
                                    <LogOut size={20} />
                                    <span className="hidden md:inline">Salir</span>
                                </button>
                            )}
                        </div>
                    </div>
                    {menuAbierto && (
                        <nav className="md:hidden bg-[#5a1515] text-white p-4 space-y-3 shadow-inner">
                            {categorias.filter(c => c !== 'Todos').slice(0, 6).map((cat, idx) => (
                                <button
                                    key={cat}
                                    onClick={() => irACatalogo(cat)}
                                    className={`block w-full text-left font-bold text-lg ${idx < 5 ? 'border-b border-[#761C1C] pb-2' : ''} ${idx === 5 ? 'text-[#D4AF37]' : ''}`}
                                >
                                    {String(cat).toUpperCase()}
                                </button>
                            ))}
                        </nav>
                    )}
                </header>
            );

            const Hero = () => (
                <div className="relative h-screen bg-gradient-to-br from-[#1a1a1a] via-[#761C1C] to-[#2a0a0a] flex items-center justify-center overflow-hidden">
                    <div className="absolute inset-0 opacity-20 bg-[url('https://images.unsplash.com/photo-1574629810360-7efbbe195018?w=1200')] bg-cover bg-center"></div>
                    <div className="absolute inset-0 bg-gradient-to-t from-black/60 via-transparent to-black/40"></div>

                    <div className="relative z-10 text-center px-4 max-w-4xl animate-float">
                        <h2 className="text-[#D4AF37] font-bold text-xl tracking-[0.3em] mb-6 animate-pulse">PASIÓN • GLORIA • TRADICIÓN</h2>
                        <h1 className="text-6xl md:text-8xl font-black font-bebas text-white mb-8 leading-none" style={{ textShadow: '4px 4px 0px #761C1C, 8px 8px 20px rgba(0,0,0,0.5)' }}>
                            VISTE LA <br /><span className="gradient-text">GRANDEZA</span>
                        </h1>
                        <p className="text-white/90 text-lg md:text-xl mb-10 max-w-2xl mx-auto">Productos oficiales del club más grande del Perú. Calidad premium, pasión eterna.</p>
                        <button onClick={() => irACatalogo('Todos')} className="bg-gradient-to-r from-[#D4AF37] to-[#FFD700] text-[#761C1C] px-10 py-5 rounded-full font-black text-xl hover:scale-110 transition-all shadow-2xl hover:shadow-[#D4AF37]/50">
                            EXPLORAR COLECCIÓN
                        </button>
                    </div>
                </div>
            );

            const ProductCard = ({ producto }) => (
                <div className="bg-white rounded-2xl overflow-hidden shadow-lg hover-lift border border-gray-100">
                    <div className="relative overflow-hidden aspect-square cursor-pointer group" onClick={() => irAProducto(producto)}>
                        <img src={producto.imagen} alt={producto.nombre} loading="lazy" decoding="async" className="w-full h-full object-cover group-hover:scale-110 transition-transform duration-500" />
                        {producto.categoria === 'Ediciones Limitadas' && (
                            <div className="absolute top-3 right-3 bg-gradient-to-r from-[#D4AF37] to-[#FFD700] text-[#761C1C] text-xs font-black px-4 py-2 rounded-full uppercase shadow-lg">
                                Exclusivo
                            </div>
                        )}
                    </div>
                    <div className="p-5">
                        <div className="text-xs text-[#D4AF37] mb-2 font-bold uppercase tracking-wider">{producto.categoria}</div>
                        <h3 className="font-bold text-gray-900 text-lg mb-3 leading-tight">{producto.nombre}</h3>
                        <div className="flex items-center justify-between">
                            <span className="text-2xl font-black text-[#761C1C]">S/ {producto.precio.toFixed(2)}</span>
                            <button onClick={() => agregarAlCarrito(producto)} className="bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-white p-3 rounded-full hover:scale-110 transition-all shadow-lg">
                                <ShoppingBag size={20} />
                            </button>
                        </div>
                    </div>
                </div>
            );

            const CartView = () => (
                <div className="pt-24 pb-12 px-4 container mx-auto max-w-3xl min-h-screen">
                    <h2 className="text-4xl font-black font-bebas text-[#761C1C] mb-10 text-center">TU CARRITO</h2>
                    {carrito.length === 0 ? (
                        <div className="text-center py-20">
                            <ShoppingBag size={80} className="mx-auto text-gray-300 mb-6" />
                            <p className="text-2xl text-gray-500 mb-8">Tu carrito está vacío</p>
                            <button onClick={() => irACatalogo()} className="bg-[#761C1C] text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition-all">Ir a la tienda</button>
                        </div>
                    ) : (
                        <>
                            <div className="space-y-4 mb-8">
                                {carrito.map(item => (
                                    <div key={item.id} className="flex items-center gap-4 bg-white p-5 rounded-xl shadow-md border border-gray-100">
                                        <img src={item.imagen} alt={item.nombre} loading="lazy" decoding="async" className="w-24 h-24 object-cover rounded-lg" />
                                        <div className="flex-1">
                                            <h3 className="font-bold text-gray-800 text-base">{item.nombre}</h3>
                                            <p className="text-[#761C1C] font-black text-lg">S/ {item.precio.toFixed(2)}</p>
                                        </div>
                                        <div className="flex items-center gap-4">
                                            <span className="text-gray-700 font-bold">x{item.cantidad}</span>
                                            <button onClick={() => eliminarDelCarrito(item.id)} className="text-red-500 hover:text-red-700 hover:scale-110 transition-all">
                                                <Trash2 size={22} />
                                            </button>
                                        </div>
                                    </div>
                                ))}
                            </div>
                            <div className="bg-gradient-to-br from-[#FDFBD4] to-[#F5E6B3] p-8 rounded-2xl shadow-xl mb-8">
                                <div className="flex justify-between text-2xl font-black text-[#761C1C]">
                                    <span>TOTAL</span>
                                    <span>S/ {totalCarrito.toFixed(2)}</span>
                                </div>
                            </div>
                            <button
                                onClick={() => {
                                    setCheckoutOk(null);
                                    setCheckoutData({ nombre: '', whatsapp: '', archivo: null });
                                    setCheckoutErrors({ nombre: '', whatsapp: '', archivo: '' });
                                    setVista('checkout');
                                }}
                                className="block w-full bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-[#FDFBD4] py-5 rounded-xl font-black text-xl text-center transition-all shadow-2xl hover:scale-105"
                            >
                                PAGAR CON YAPE
                            </button>
                        </>
                    )}
                </div>
            );

            const checkoutView = (
                <div className="pt-24 pb-12 px-4 container mx-auto max-w-3xl min-h-screen">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-4xl font-black font-bebas text-[#761C1C]">CHECKOUT</h2>
                        <button onClick={() => setVista('carrito')} className="text-gray-600 hover:text-[#761C1C] font-bold">
                            ← Volver
                        </button>
                    </div>

                    {checkoutOk ? (
                        <div className="bg-white rounded-2xl shadow-lg p-8">
                            <h3 className="text-3xl font-black font-bebas text-[#761C1C] mb-4">PEDIDO RECIBIDO</h3>
                            <p className="text-gray-700 mb-6">Tu pedido quedó en estado <span className="font-black">{checkoutOk.estado}</span>.</p>
                            <div className="bg-gray-50 rounded-xl p-5 mb-6 border border-gray-100">
                                <div className="text-sm text-gray-500 mb-1">Código de pedido</div>
                                <div className="text-xl font-black text-gray-900">{checkoutOk.id}</div>
                            </div>
                            <a
                                href={`https://wa.me/51937595257?text=${encodeURIComponent(`Hola Nación U Crema, mi pedido es ${checkoutOk.id}.`)}`}
                                target="_blank"
                                rel="noopener noreferrer"
                                className="block w-full bg-green-500 text-white py-4 rounded-xl font-black text-lg text-center hover:bg-green-600 transition-colors"
                            >
                                HABLAR POR WHATSAPP
                            </a>
                        </div>
                    ) : carrito.length === 0 ? (
                        <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                            <ShoppingBag size={80} className="mx-auto text-gray-300 mb-6" />
                            <p className="text-2xl text-gray-500 mb-8">Tu carrito está vacío</p>
                            <button onClick={() => irACatalogo()} className="bg-[#761C1C] text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition-all">
                                Ir a la tienda
                            </button>
                        </div>
                    ) : (
                        <div className="grid md:grid-cols-2 gap-8">
                            <div className="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                                <h3 className="text-2xl font-black font-bebas text-[#761C1C] mb-4">PAGA POR YAPE</h3>
                                <div className="bg-gray-50 rounded-xl p-4 border border-gray-100">
                                    <img src="assets/QR.jpg" alt="QR Yape" className="w-full h-auto rounded-lg" />
                                </div>
                                <div className="mt-4 text-sm text-gray-600">
                                    Total a pagar: <span className="font-black text-gray-900">S/ {Number(totalCarrito).toFixed(2)}</span>
                                </div>
                            </div>

                            <div className="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                                <h3 className="text-2xl font-black font-bebas text-[#761C1C] mb-4">SUBE TU COMPROBANTE</h3>
                                <form className="space-y-4" onSubmit={(e) => { e.preventDefault(); crearPedidoYape(); }}>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">Nombre</label>
                                        <input
                                            type="text"
                                            value={checkoutData.nombre}
                                            onKeyDown={(e) => e.stopPropagation()}
                                            onChange={(e) => {
                                                const v = normalizarNombreSoloLetras(e.target.value);
                                                setCheckoutData((prev) => ({ ...prev, nombre: v }));
                                                setCheckoutErrors((prev) => ({ ...prev, nombre: '' }));
                                            }}
                                            onBlur={(e) => setCheckoutErrors((prev) => ({ ...prev, nombre: validarNombre(e.target.value) }))}
                                            className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${checkoutErrors.nombre ? 'border-red-500' : 'border-gray-200'}`}
                                            placeholder="Tu nombre"
                                        />
                                        {checkoutErrors.nombre && <div className="text-sm text-red-600 mt-2 font-bold">{checkoutErrors.nombre}</div>}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">WhatsApp</label>
                                        <input
                                            type="tel"
                                            inputMode="numeric"
                                            maxLength={9}
                                            value={checkoutData.whatsapp}
                                            onKeyDown={(e) => e.stopPropagation()}
                                            onChange={(e) => {
                                                const v = normalizarWhatsapp(e.target.value);
                                                setCheckoutData((prev) => ({ ...prev, whatsapp: v }));
                                                setCheckoutErrors((prev) => ({ ...prev, whatsapp: '' }));
                                            }}
                                            onBlur={(e) => setCheckoutErrors((prev) => ({ ...prev, whatsapp: validarWhatsapp(e.target.value) }))}
                                            className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${checkoutErrors.whatsapp ? 'border-red-500' : 'border-gray-200'}`}
                                            placeholder="Ej: 999888777"
                                        />
                                        {checkoutErrors.whatsapp && <div className="text-sm text-red-600 mt-2 font-bold">{checkoutErrors.whatsapp}</div>}
                                    </div>
                                    <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">Comprobante (JPG/PNG, máx 2MB)</label>
                                        <input
                                            type="file"
                                            accept="image/png,image/jpeg"
                                            onChange={(e) => {
                                                const file = e.target.files?.[0] || null;
                                                setCheckoutData((prev) => ({ ...prev, archivo: file }));
                                                const valid = validarImagen(file);
                                                setCheckoutErrors((prev) => ({ ...prev, archivo: valid.ok ? '' : valid.error }));
                                            }}
                                            className="w-full"
                                        />
                                        {checkoutErrors.archivo && <div className="text-sm text-red-600 mt-2 font-bold">{checkoutErrors.archivo}</div>}
                                    </div>
                                    <button
                                        type="submit"
                                        disabled={checkoutCargando}
                                        className={`w-full bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-white py-4 rounded-xl font-black text-lg transition-all shadow-lg ${checkoutCargando ? 'opacity-70 cursor-not-allowed' : 'hover:scale-105'}`}
                                    >
                                        {checkoutCargando ? 'SUBIENDO...' : 'ENVIAR COMPROBANTE'}
                                    </button>
                                </form>
                            </div>
                        </div>
                    )}
                </div>
            );

            const adminView = (
                <div className="pt-24 pb-12 px-4 container mx-auto max-w-6xl min-h-screen">
                    <div className="flex items-center justify-between mb-8">
                        <h2 className="text-4xl font-black font-bebas text-[#761C1C]">ADMIN</h2>
                        <button onClick={() => setVista('inicio')} className="text-gray-600 hover:text-[#761C1C] font-bold">
                            ← Volver
                        </button>
                    </div>

                    {!usuario ? (
                        <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                            <User size={80} className="mx-auto text-gray-300 mb-6" />
                            <p className="text-2xl text-gray-500 mb-8">Inicia sesión para acceder</p>
                            <button onClick={() => setMostrarAuth(true)} className="bg-[#761C1C] text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition-all">
                                Ingresar
                            </button>
                        </div>
                    ) : adminCargando ? (
                        <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                            <p className="text-xl text-gray-500">Verificando permisos...</p>
                        </div>
                    ) : !esAdmin ? (
                        <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                            <p className="text-xl text-gray-500">Acceso restringido</p>
                        </div>
                    ) : (
                        <div className="bg-white rounded-2xl shadow-lg p-6 border border-gray-100">
                            <div className="flex items-center justify-between mb-4">
                                <div className="text-sm text-gray-500">Pedidos</div>
                                <button onClick={cargarPedidosAdmin} className="bg-[#761C1C] text-white px-4 py-2 rounded-lg font-bold hover:opacity-90 transition">
                                    Actualizar
                                </button>
                            </div>

                            <div className="flex flex-col lg:flex-row gap-4 mb-6">
                                <input
                                    type="text"
                                    value={adminBusqueda}
                                    onKeyDown={(e) => e.stopPropagation()}
                                    onChange={(e) => setAdminBusqueda(e.target.value)}
                                    className="flex-1 px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors"
                                    placeholder="Buscar por nombre, WhatsApp, ID o estado"
                                />
                                <div className="flex flex-wrap gap-2">
                                    <button onClick={() => setAdminFiltroEstado('todos')} className={`px-4 py-2 rounded-full font-black text-sm border-2 ${adminFiltroEstado === 'todos' ? 'bg-[#761C1C] text-white border-[#761C1C]' : 'bg-white text-gray-700 border-gray-200 hover:border-[#761C1C]'}`}>
                                        Todos
                                    </button>
                                    <button onClick={() => setAdminFiltroEstado('pendiente')} className={`px-4 py-2 rounded-full font-black text-sm border-2 ${adminFiltroEstado === 'pendiente' ? 'bg-yellow-500 text-white border-yellow-500' : 'bg-white text-gray-700 border-gray-200 hover:border-yellow-500'}`}>
                                        Pendientes
                                    </button>
                                    <button onClick={() => setAdminFiltroEstado('pagado')} className={`px-4 py-2 rounded-full font-black text-sm border-2 ${adminFiltroEstado === 'pagado' ? 'bg-green-600 text-white border-green-600' : 'bg-white text-gray-700 border-gray-200 hover:border-green-600'}`}>
                                        Pagados
                                    </button>
                                </div>
                                <select
                                    value={adminOrdenFecha}
                                    onChange={(e) => setAdminOrdenFecha(e.target.value)}
                                    className="px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors font-bold text-sm"
                                >
                                    <option value="desc">Más recientes</option>
                                    <option value="asc">Más antiguos</option>
                                </select>
                            </div>

                            {adminPedidosCargando ? (
                                <div className="text-center py-16 text-gray-500">Cargando...</div>
                            ) : adminPedidosError ? (
                                <div className="text-center py-16 text-gray-500">{adminPedidosError}</div>
                            ) : adminPedidosFiltrados.length === 0 ? (
                                <div className="text-center py-16 text-gray-500">No hay pedidos</div>
                            ) : (
                                <div className="overflow-x-auto">
                                    <table className="min-w-full text-sm">
                                        <thead className="text-left text-gray-500 border-b">
                                            <tr>
                                                <th className="py-3 pr-4">Fecha</th>
                                                <th className="py-3 pr-4">Cliente</th>
                                                <th className="py-3 pr-4">WhatsApp</th>
                                                <th className="py-3 pr-4">Total</th>
                                                <th className="py-3 pr-4">Estado</th>
                                                <th className="py-3 pr-4">Comprobante</th>
                                                <th className="py-3 pr-4">Acciones</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            {adminPedidosFiltrados.map(p => (
                                                <tr key={p.id} className="border-b last:border-b-0">
                                                    <td className="py-4 pr-4 whitespace-nowrap text-gray-700">{p.created_at ? new Date(p.created_at).toLocaleString('es-PE') : ''}</td>
                                                    <td className="py-4 pr-4 text-gray-900 font-bold">{p.cliente_nombre}</td>
                                                    <td className="py-4 pr-4">
                                                        <a
                                                            href={`https://wa.me/51${normalizarWhatsapp(p.cliente_whatsapp)}?text=${encodeURIComponent(`Hola ${p.cliente_nombre}, te escribo por tu pedido ${p.id}.`)}`}
                                                            target="_blank"
                                                            rel="noopener noreferrer"
                                                            className="text-green-600 font-bold hover:underline"
                                                        >
                                                            {p.cliente_whatsapp}
                                                        </a>
                                                    </td>
                                                    <td className="py-4 pr-4 font-black text-[#761C1C]">S/ {Number(p.total).toFixed(2)}</td>
                                                    <td className="py-4 pr-4">
                                                        <span className={`px-3 py-1 rounded-full text-xs font-black ${p.estado === 'pagado' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'}`}>
                                                            {p.estado}
                                                        </span>
                                                    </td>
                                                    <td className="py-4 pr-4">
                                                        {p.comprobante_url ? (
                                                            <img
                                                                src={p.comprobante_url}
                                                                alt="Comprobante"
                                                                className="h-12 w-12 object-cover rounded-lg border cursor-pointer"
                                                                onClick={() => setAdminImagen(p.comprobante_url)}
                                                            />
                                                        ) : (
                                                            <span className="text-gray-400">—</span>
                                                        )}
                                                    </td>
                                                    <td className="py-4 pr-4">
                                                        <button
                                                            disabled={p.estado === 'pagado'}
                                                            onClick={() => confirmarPago(p.id)}
                                                            className={`px-4 py-2 rounded-lg font-black text-xs ${p.estado === 'pagado' ? 'bg-gray-200 text-gray-500 cursor-not-allowed' : 'bg-[#761C1C] text-white hover:opacity-90'}`}
                                                        >
                                                            Confirmar Pago
                                                        </button>
                                                        <button
                                                            onClick={() => abrirDetalleAdmin(p)}
                                                            className="ml-2 px-4 py-2 rounded-lg font-black text-xs bg-black/10 hover:bg-black/20 text-gray-800"
                                                        >
                                                            Ver detalle
                                                        </button>
                                                    </td>
                                                </tr>
                                            ))}
                                        </tbody>
                                    </table>
                                </div>
                            )}
                        </div>
                    )}

                    {adminDetalle && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={() => setAdminDetalle(null)}>
                            <div className="max-w-4xl w-full bg-white rounded-2xl overflow-hidden" onClick={(e) => e.stopPropagation()}>
                                <div className="p-4 flex justify-between items-center border-b">
                                    <div className="font-black text-gray-900">Historial del cliente</div>
                                    <button onClick={() => setAdminDetalle(null)} className="text-gray-500 hover:text-gray-800 font-black">X</button>
                                </div>
                                <div className="p-6 space-y-5">
                                    <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                        <div>
                                            <div className="text-sm text-gray-500">Cliente</div>
                                            <div className="text-xl font-black text-gray-900">{adminDetalle.cliente_nombre}</div>
                                            <div className="text-sm text-gray-600">{adminDetalle.cliente_whatsapp}</div>
                                        </div>
                                        <div className="text-right">
                                            <div className="text-sm text-gray-500">Pedido seleccionado</div>
                                            <div className="text-lg font-black text-[#761C1C]">{adminDetalle.id}</div>
                                        </div>
                                    </div>

                                    {adminHistorialCargando ? (
                                        <div className="text-center py-10 text-gray-500">Cargando historial...</div>
                                    ) : adminHistorialError ? (
                                        <div className="text-center py-10 text-gray-500">{adminHistorialError}</div>
                                    ) : adminHistorial.length === 0 ? (
                                        <div className="text-center py-10 text-gray-500">No hay pedidos</div>
                                    ) : (
                                        <div className="space-y-4">
                                            {adminHistorial.map(h => {
                                                const it = parseItems(h.items);
                                                return (
                                                    <div key={h.id} className="border rounded-xl p-4">
                                                        <div className="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                                                            <div className="font-black text-gray-900">Pedido #{h.id}</div>
                                                            <div className="flex items-center gap-3">
                                                                <span className={`px-3 py-1 rounded-full text-xs font-black ${h.estado === 'pagado' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'}`}>{h.estado}</span>
                                                                <div className="font-black text-[#761C1C]">S/ {Number(h.total).toFixed(2)}</div>
                                                            </div>
                                                        </div>
                                                        <div className="text-sm text-gray-500 mt-1">{h.created_at ? new Date(h.created_at).toLocaleString('es-PE') : ''}</div>
                                                        {it.length > 0 && (
                                                            <div className="mt-3 space-y-1 text-sm">
                                                                {it.map((x, idx) => (
                                                                    <div key={`${h.id}-${idx}`} className="flex justify-between">
                                                                        <span className="text-gray-700">{x?.nombre || 'Producto'} x{Number(x?.cantidad) || 0}</span>
                                                                        <span className="font-bold text-gray-900">S/ {(Number(x?.precio || 0) * Number(x?.cantidad || 0)).toFixed(2)}</span>
                                                                    </div>
                                                                ))}
                                                            </div>
                                                        )}
                                                        <div className="mt-4 flex items-center gap-4">
                                                            {h.comprobante_url && (
                                                                <button onClick={() => { setAdminImagen(h.comprobante_url); }} className="text-[#761C1C] font-bold hover:underline text-sm">
                                                                    Ver comprobante
                                                                </button>
                                                            )}
                                                            {h.estado !== 'pagado' && (
                                                                <button onClick={() => confirmarPago(h.id)} className="bg-[#761C1C] text-white px-4 py-2 rounded-lg font-black text-xs hover:opacity-90">
                                                                    Marcar pagado
                                                                </button>
                                                            )}
                                                        </div>
                                                    </div>
                                                );
                                            })}
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {adminImagen && (
                        <div className="fixed inset-0 bg-black/70 z-50 flex items-center justify-center p-4" onClick={() => setAdminImagen(null)}>
                            <div className="max-w-4xl w-full bg-white rounded-2xl overflow-hidden max-h-[90vh] flex flex-col" onClick={(e) => e.stopPropagation()}>
                                <div className="p-4 flex justify-between items-center border-b">
                                    <div className="font-black text-gray-900">Comprobante</div>
                                    <button onClick={() => setAdminImagen(null)} className="text-gray-500 hover:text-gray-800 font-black">X</button>
                                </div>
                                <div className="bg-black flex-1 min-h-0 overflow-auto p-2">
                                    <img src={adminImagen} alt="Comprobante" className="w-full h-full object-contain" />
                                </div>
                            </div>
                        </div>
                    )}
                </div>
            );

            return (
                <div className="min-h-screen bg-gray-50">
                    <Header />
                    <main>
                        {vista === 'inicio' && (
                            <>
                                <Hero />
                                <div className="container mx-auto px-4 py-20">
                                    <div className="text-center mb-12">
                                        <h2 className="text-5xl font-black font-bebas text-[#761C1C] mb-4">PRODUCTOS DESTACADOS</h2>
                                        <div className="h-1 w-32 bg-gradient-to-r from-[#D4AF37] to-[#FFD700] mx-auto"></div>
                                    </div>
                                    {cargandoProductos && (
                                        <div className="text-center text-sm text-gray-500 mb-6">Cargando productos...</div>
                                    )}
                                    {productosOrigen === 'demo' && supabaseClient && !cargandoProductos && (
                                        <div className="text-center text-sm text-amber-800 bg-amber-50 border border-amber-200 rounded-xl px-4 py-3 mb-6">
                                            No se encontraron productos en Supabase; mostrando productos de prueba.
                                        </div>
                                    )}
                                    <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                        {productos.map(p => <ProductCard key={p.id} producto={p} />)}
                                    </div>
                                    <div className="text-center mt-12">
                                        <button onClick={() => irACatalogo()} className="bg-black text-white px-10 py-4 rounded-full font-bold hover:scale-105 transition-all inline-flex items-center gap-2">
                                            VER TODO <ChevronRight />
                                        </button>
                                    </div>
                                </div>
                            </>
                        )}
                        {vista === 'catalogo' && (
                            <div className="pt-24 px-4 container mx-auto min-h-screen pb-20">
                                <div className="flex gap-3 overflow-x-auto pb-6 mb-10 no-scrollbar">
                                    {categorias.map(cat => (
                                        <button key={cat} onClick={() => setFiltroCategoria(cat)} className={`px-6 py-3 rounded-full font-bold whitespace-nowrap transition-all ${filtroCategoria === cat ? 'bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-[#D4AF37] shadow-lg scale-105' : 'bg-white text-gray-600 border-2 border-gray-200 hover:border-[#761C1C]'}`}>
                                            {cat}
                                        </button>
                                    ))}
                                </div>
                                <div className="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-8">
                                    {productos.filter(p => filtroCategoria === 'Todos' || p.categoria === filtroCategoria).map(p => <ProductCard key={p.id} producto={p} />)}
                                </div>
                            </div>
                        )}
                        {vista === 'producto' && productoSeleccionado && (
                            <div className="pt-24 pb-12 px-4 container mx-auto">
                                <button onClick={() => setVista('catalogo')} className="mb-8 flex items-center text-gray-600 hover:text-[#761C1C] font-bold">
                                    ← Volver al catálogo
                                </button>
                                <div className="grid md:grid-cols-2 gap-12 items-start">
                                    <div className="rounded-3xl overflow-hidden shadow-2xl border-4 border-[#FDFBD4]">
                                        <img src={productoSeleccionado.imagen} alt={productoSeleccionado.nombre} loading="lazy" decoding="async" className="w-full h-full object-cover" />
                                    </div>
                                    <div>
                                        <span className="text-[#D4AF37] font-black tracking-widest uppercase text-sm">{productoSeleccionado.categoria}</span>
                                        <h1 className="text-4xl md:text-6xl font-black font-bebas text-[#761C1C] mt-3 mb-6 leading-none">{productoSeleccionado.nombre}</h1>
                                        <p className="text-gray-700 text-lg mb-8 leading-relaxed">{productoSeleccionado.descripcion}</p>
                                        <div className="text-5xl font-black text-gray-900 mb-10">S/ {productoSeleccionado.precio.toFixed(2)}</div>
                                        <div className="flex gap-4 mb-10">
                                            <button onClick={() => { agregarAlCarrito(productoSeleccionado); setVista('carrito'); }} className="flex-1 bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-[#FDFBD4] py-5 rounded-xl font-black text-lg hover:scale-105 transition-all shadow-2xl">
                                                COMPRAR AHORA
                                            </button>
                                            <button onClick={() => agregarAlCarrito(productoSeleccionado)} className="px-6 py-5 border-2 border-gray-300 rounded-xl hover:border-[#761C1C] hover:scale-105 transition-all">
                                                <ShoppingBag size={28} className="text-gray-700" />
                                            </button>
                                        </div>
                                        <div className="grid grid-cols-2 gap-4 text-sm bg-gray-50 p-6 rounded-xl">
                                            <div className="flex items-center gap-2"><Truck size={18} className="text-[#D4AF37]" /> Envíos a todo Perú</div>
                                            <div className="flex items-center gap-2"><ShieldCheck size={18} className="text-[#D4AF37]" /> Compra Segura</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        )}
                        {vista === 'checkout' && checkoutView}
                        {vista === 'admin' && adminView}
                        {vista === 'carrito' && <CartView />}
                    </main>

                    {/* Modal de Autenticación */}
                    {mostrarAuth && (
                        <div className="fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4" onClick={() => setMostrarAuth(false)}>
                            <div className="bg-white rounded-2xl shadow-2xl max-w-md w-full p-8" onClick={(e) => e.stopPropagation()}>
                                <div className="flex justify-between items-center mb-6">
                                    <h2 className="text-3xl font-black font-bebas text-[#761C1C]">
                                        {getTituloAuth()}
                                    </h2>
                                    <button onClick={() => setMostrarAuth(false)} className="text-gray-400 hover:text-gray-600">
                                        <X size={24} />
                                    </button>
                                </div>

                                <form onSubmit={handleAuthSubmit} className="space-y-4">
                                    {modoAuth === 'registro' && (
                                        <>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Nombre Completo</label>
                                                <input
                                                    type="text"
                                                    required
                                                    value={formData.nombre}
                                                    onKeyDown={(e) => e.stopPropagation()}
                                                    onChange={(e) => {
                                                        const v = normalizarNombreSoloLetras(e.target.value);
                                                        setFormData({ ...formData, nombre: v });
                                                        setAuthErrors({ ...authErrors, nombre: '' });
                                                    }}
                                                    onBlur={(e) => setAuthErrors({ ...authErrors, nombre: validarNombre(e.target.value) })}
                                                    className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${authErrors.nombre ? 'border-red-500' : 'border-gray-200'}`}
                                                    placeholder="Juan Pérez"
                                                />
                                                {authErrors.nombre && <div className="text-sm text-red-600 mt-2 font-bold">{authErrors.nombre}</div>}
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Celular</label>
                                                <input
                                                    type="tel"
                                                    required
                                                    value={formData.celular}
                                                    inputMode="numeric"
                                                    maxLength={9}
                                                    onKeyDown={(e) => e.stopPropagation()}
                                                    onChange={(e) => {
                                                        const v = normalizarWhatsapp(e.target.value);
                                                        setFormData({ ...formData, celular: v });
                                                        setAuthErrors({ ...authErrors, celular: '' });
                                                    }}
                                                    onBlur={(e) => setAuthErrors({ ...authErrors, celular: validarCelular(e.target.value) })}
                                                    className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${authErrors.celular ? 'border-red-500' : 'border-gray-200'}`}
                                                    placeholder="Ej: 999888777"
                                                />
                                                {authErrors.celular && <div className="text-sm text-red-600 mt-2 font-bold">{authErrors.celular}</div>}
                                            </div>
                                        </>
                                    )}

                                    {(modoAuth === 'login' || modoAuth === 'registro' || modoAuth === 'forgot_email') && (
                                        <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">Email</label>
                                        <input
                                            type="email"
                                            required
                                            value={formData.email}
                                            onKeyDown={(e) => e.stopPropagation()}
                                            onChange={(e) => {
                                                const v = e.target.value;
                                                setFormData({ ...formData, email: v });
                                                setAuthErrors({ ...authErrors, email: '' });
                                            }}
                                            onBlur={(e) => setAuthErrors({ ...authErrors, email: validarEmail(e.target.value) })}
                                            className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${authErrors.email ? 'border-red-500' : 'border-gray-200'}`}
                                            placeholder="tu@email.com"
                                        />
                                        {authErrors.email && <div className="text-sm text-red-600 mt-2 font-bold">{authErrors.email}</div>}
                                        </div>
                                    )}

                                    {(modoAuth === 'login' || modoAuth === 'registro') && (
                                        <div>
                                        <label className="block text-sm font-bold text-gray-700 mb-2">Contraseña</label>
                                        <input
                                            type="password"
                                            required
                                            value={formData.password}
                                            onKeyDown={(e) => e.stopPropagation()}
                                            onChange={(e) => {
                                                const v = e.target.value;
                                                setFormData({ ...formData, password: v });
                                                setAuthErrors({ ...authErrors, password: '' });
                                            }}
                                            onBlur={(e) => setAuthErrors({ ...authErrors, password: validarPassword(e.target.value) })}
                                            className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${authErrors.password ? 'border-red-500' : 'border-gray-200'}`}
                                            placeholder="••••••••"
                                        />
                                        {authErrors.password && <div className="text-sm text-red-600 mt-2 font-bold">{authErrors.password}</div>}
                                        </div>
                                    )}

                                    {modoAuth === 'registro' && (
                                        <div>
                                            <label className="block text-sm font-bold text-gray-700 mb-2">Repetir Contraseña</label>
                                            <input
                                                type="password"
                                                required
                                                value={formData.password2}
                                                onKeyDown={(e) => e.stopPropagation()}
                                                onChange={(e) => setFormData({ ...formData, password2: e.target.value })}
                                                className="w-full px-4 py-3 border-2 border-gray-200 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors"
                                                placeholder="••••••••"
                                            />
                                        </div>
                                    )}

                                    {(modoAuth === 'registro_codigo' || modoAuth === 'forgot_codigo') && (
                                        <div className="space-y-2">
                                            <div className="text-sm text-gray-600">
                                                Te enviamos un código a <span className="font-black text-gray-900">{otpState.email}</span>
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Código</label>
                                                <input
                                                    type="text"
                                                    inputMode="numeric"
                                                    value={otpState.codigo}
                                                    onKeyDown={(e) => e.stopPropagation()}
                                                    onChange={(e) => setOtpState((prev) => ({ ...prev, codigo: e.target.value }))}
                                                    className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${otpError ? 'border-red-500' : 'border-gray-200'}`}
                                                    placeholder="Ej: 123456"
                                                />
                                                {otpError && <div className="text-sm text-red-600 mt-2 font-bold">{otpError}</div>}
                                            </div>
                                            <button
                                                type="button"
                                                disabled={authCargando}
                                                onClick={reenviarCodigoOtp}
                                                className={`text-sm font-bold text-[#761C1C] ${authCargando ? 'opacity-70 cursor-not-allowed' : 'hover:underline'}`}
                                            >
                                                Reenviar código
                                            </button>
                                        </div>
                                    )}

                                    {modoAuth === 'reset_password' && (
                                        <div className="space-y-4">
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Nueva Contraseña</label>
                                                <input
                                                    type="password"
                                                    value={resetState.password}
                                                    onKeyDown={(e) => e.stopPropagation()}
                                                    onChange={(e) => { setResetState((prev) => ({ ...prev, password: e.target.value })); setResetError(''); }}
                                                    className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${resetError ? 'border-red-500' : 'border-gray-200'}`}
                                                    placeholder="••••••••"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-bold text-gray-700 mb-2">Repetir Nueva Contraseña</label>
                                                <input
                                                    type="password"
                                                    value={resetState.password2}
                                                    onKeyDown={(e) => e.stopPropagation()}
                                                    onChange={(e) => { setResetState((prev) => ({ ...prev, password2: e.target.value })); setResetError(''); }}
                                                    className={`w-full px-4 py-3 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${resetError ? 'border-red-500' : 'border-gray-200'}`}
                                                    placeholder="••••••••"
                                                />
                                                {resetError && <div className="text-sm text-red-600 mt-2 font-bold">{resetError}</div>}
                                            </div>
                                        </div>
                                    )}

                                    <button
                                        type="submit"
                                        disabled={authCargando}
                                        className={`w-full bg-gradient-to-r from-[#761C1C] to-[#5a1515] text-white py-4 rounded-lg font-black text-lg transition-all shadow-lg ${authCargando ? 'opacity-70 cursor-not-allowed' : 'hover:scale-105'}`}
                                    >
                                        {authCargando ? 'PROCESANDO...' : (
                                            modoAuth === 'login' ? 'INGRESAR'
                                                : modoAuth === 'registro' ? 'ENVIAR CÓDIGO'
                                                    : modoAuth === 'registro_codigo' ? 'VERIFICAR'
                                                        : modoAuth === 'forgot_email' ? 'ENVIAR CÓDIGO'
                                                            : modoAuth === 'forgot_codigo' ? 'VERIFICAR'
                                                                : modoAuth === 'reset_password' ? 'ACTUALIZAR CONTRASEÑA'
                                                                    : 'CONTINUAR'
                                        )}
                                    </button>
                                </form>

                                <div className="mt-6 text-center">
                                    {modoAuth === 'login' && (
                                        <button
                                            disabled={authCargando}
                                            onClick={() => {
                                                setModoAuth('forgot_email');
                                                setOtpError('');
                                                setResetError('');
                                                setOtpState({ email: '', codigo: '' });
                                                setResetState({ password: '', password2: '' });
                                                setAuthErrors({ nombre: '', celular: '', email: '', password: '' });
                                                setFormData({ nombre: '', celular: '', email: formData.email, password: '', password2: '' });
                                            }}
                                            className={`block w-full text-sm text-gray-600 ${authCargando ? 'opacity-70 cursor-not-allowed' : 'hover:underline'}`}
                                        >
                                            ¿Olvidaste tu contraseña?
                                        </button>
                                    )}
                                    <button
                                        disabled={authCargando}
                                        onClick={() => {
                                            setModoAuth(modoAuth === 'login' ? 'registro' : 'login');
                                            setOtpError('');
                                            setResetError('');
                                            setOtpState({ email: '', codigo: '' });
                                            setResetState({ password: '', password2: '' });
                                            setRegistroPendiente({ email: '', password: '' });
                                            setFormData({ nombre: '', celular: '', email: '', password: '', password2: '' });
                                            setAuthErrors({ nombre: '', celular: '', email: '', password: '' });
                                        }}
                                        className={`text-[#761C1C] font-bold ${authCargando ? 'opacity-70 cursor-not-allowed' : 'hover:underline'}`}
                                    >
                                        {modoAuth === 'login' ? '¿No tienes cuenta? Regístrate' : '¿Ya tienes cuenta? Inicia sesión'}
                                    </button>
                                    {(modoAuth === 'registro_codigo' || modoAuth === 'forgot_codigo' || modoAuth === 'reset_password' || modoAuth === 'forgot_email') && (
                                        <div className="mt-3">
                                            <button
                                                disabled={authCargando}
                                                onClick={() => {
                                                    setModoAuth('login');
                                                    setOtpError('');
                                                    setResetError('');
                                                    setOtpState({ email: '', codigo: '' });
                                                    setResetState({ password: '', password2: '' });
                                                    setRegistroPendiente({ email: '', password: '' });
                                                    setAuthErrors({ nombre: '', celular: '', email: '', password: '' });
                                                    setFormData({ nombre: '', celular: '', email: '', password: '', password2: '' });
                                                }}
                                                className={`text-sm text-gray-600 ${authCargando ? 'opacity-70 cursor-not-allowed' : 'hover:underline'}`}
                                            >
                                                Volver a iniciar sesión
                                            </button>
                                        </div>
                                    )}
                                </div>
                            </div>
                        </div>
                    )}

                    {/* Vista de Perfil */}
                    {vista === 'perfil' && (
                        <div className="pt-24 pb-12 px-4 container mx-auto max-w-4xl min-h-screen">
                            <div className="bg-gradient-to-br from-[#761C1C] to-[#5a1515] text-white rounded-2xl p-8 mb-8 shadow-2xl">
                                <div className="flex items-center gap-4">
                                    <div className="bg-white/20 p-4 rounded-full">
                                        <User size={48} />
                                    </div>
                                    <div>
                                        <h1 className="text-3xl font-black font-bebas">¡Hola, {getNombreUsuario(usuario)}!</h1>
                                        <p className="text-[#FDFBD4]">{usuario?.email}</p>
                                    </div>
                                </div>
                            </div>

                            <h2 className="text-3xl font-black font-bebas text-[#761C1C] mb-6">MIS PEDIDOS</h2>

                            {!usuario ? (
                                <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                                    <User size={80} className="mx-auto text-gray-300 mb-6" />
                                    <p className="text-2xl text-gray-500 mb-8">Inicia sesión para ver tus pedidos</p>
                                    <button onClick={() => setMostrarAuth(true)} className="bg-[#761C1C] text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition-all">
                                        Ingresar
                                    </button>
                                </div>
                            ) : String(usuario?.email || '').trim().toLowerCase() === 'loarojas3@gmail.com' && !esAdmin ? (
                                <div className="bg-white rounded-2xl shadow-lg p-6 border border-gray-100 mb-8">
                                    <div className="font-black text-lg text-gray-900 mb-2">Activar Admin</div>
                                    <div className="text-sm text-gray-600 mb-4">Ingresa tu código secreto para habilitar el panel /admin en esta cuenta.</div>
                                    <div className="flex flex-col md:flex-row gap-3">
                                        <div className="flex-1 relative">
                                            <input
                                                type={adminSetupMostrar ? 'text' : 'password'}
                                                value={adminSetupCode}
                                                onKeyDown={(e) => e.stopPropagation()}
                                                onChange={(e) => { setAdminSetupCode(e.target.value); setAdminSetupErr(''); setAdminSetupOk(''); }}
                                                className={`w-full px-4 py-3 pr-24 border-2 rounded-lg focus:border-[#761C1C] focus:outline-none transition-colors ${adminSetupErr ? 'border-red-500' : 'border-gray-200'}`}
                                                placeholder="Código de administrador"
                                            />
                                            <button
                                                type="button"
                                                onClick={() => setAdminSetupMostrar(!adminSetupMostrar)}
                                                className="absolute right-3 top-1/2 -translate-y-1/2 text-sm font-black text-[#761C1C] hover:underline"
                                            >
                                                {adminSetupMostrar ? 'Ocultar' : 'Ver'}
                                            </button>
                                        </div>
                                        <button
                                            disabled={adminSetupCargando}
                                            onClick={activarAdminConCodigo}
                                            className={`bg-[#761C1C] text-white px-6 py-3 rounded-lg font-black ${adminSetupCargando ? 'opacity-70 cursor-not-allowed' : 'hover:opacity-90'}`}
                                        >
                                            {adminSetupCargando ? 'ACTIVANDO...' : 'ACTIVAR'}
                                        </button>
                                    </div>
                                    {adminSetupErr && <div className="text-sm text-red-600 mt-3 font-bold">{adminSetupErr}</div>}
                                    {adminSetupOk && <div className="text-sm text-green-700 mt-3 font-bold">{adminSetupOk}</div>}
                                </div>
                            ) : pedidosYapeCargando ? (
                                <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                                    <p className="text-xl text-gray-500">Cargando pedidos...</p>
                                </div>
                            ) : pedidosYapeError ? (
                                <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                                    <p className="text-xl text-gray-500 mb-6">{pedidosYapeError}</p>
                                    <button onClick={recargarPedidosYape} className="bg-[#761C1C] text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition-all">
                                        Reintentar
                                    </button>
                                </div>
                            ) : pedidosYape.length === 0 ? (
                                <div className="text-center py-20 bg-white rounded-2xl shadow-lg">
                                    <Package size={80} className="mx-auto text-gray-300 mb-6" />
                                    <p className="text-2xl text-gray-500 mb-8">Aún no has realizado pedidos</p>
                                    <button onClick={() => irACatalogo()} className="bg-[#761C1C] text-white px-8 py-4 rounded-full font-bold hover:scale-105 transition-all">
                                        Explorar productos
                                    </button>
                                </div>
                            ) : (
                                <div className="space-y-6">
                                    {pedidosYape.map(pedido => (
                                        <div key={pedido.id} className="bg-white rounded-xl shadow-lg p-6 border-l-4 border-[#D4AF37]">
                                            <div className="flex justify-between items-start mb-4">
                                                <div>
                                                    <h3 className="font-black text-lg text-gray-900">Pedido #{pedido.id}</h3>
                                                    <p className="text-sm text-gray-500">{new Date(pedido.created_at).toLocaleDateString('es-PE', { year: 'numeric', month: 'long', day: 'numeric' })}</p>
                                                </div>
                                                <span className={`px-4 py-2 rounded-full text-sm font-bold ${pedido.estado === 'pagado' ? 'bg-green-100 text-green-700' : 'bg-yellow-100 text-yellow-800'}`}>
                                                    {pedido.estado}
                                                </span>
                                            </div>

                                            {parseItems(pedido.items).length > 0 && (
                                                <div className="space-y-2 mb-4">
                                                    {parseItems(pedido.items).map((item, idx) => (
                                                        <div key={`${pedido.id}-${idx}`} className="flex justify-between text-sm">
                                                            <span className="text-gray-700">{item?.nombre || 'Producto'} x{Number(item?.cantidad) || 0}</span>
                                                            <span className="font-bold text-gray-900">S/ {(Number(item?.precio || 0) * Number(item?.cantidad || 0)).toFixed(2)}</span>
                                                        </div>
                                                    ))}
                                                </div>
                                            )}

                                            <div className="border-t pt-4 flex flex-col md:flex-row md:items-center md:justify-between gap-4">
                                                <span className="font-black text-xl text-[#761C1C]">Total: S/ {Number(pedido.total).toFixed(2)}</span>
                                                <div className="flex items-center gap-3">
                                                    {pedido.comprobante_url && (
                                                        <a href={pedido.comprobante_url} target="_blank" rel="noopener noreferrer" className="text-[#761C1C] font-bold hover:underline text-sm">
                                                            Ver comprobante
                                                        </a>
                                                    )}
                                                    <a
                                                        href={`https://wa.me/51937595257?text=${encodeURIComponent(`Hola, quiero consultar sobre mi pedido #${pedido.id}`)}`}
                                                        target="_blank"
                                                        rel="noopener noreferrer"
                                                        className="bg-green-500 text-white px-4 py-2 rounded-lg font-bold hover:bg-green-600 transition-colors text-sm"
                                                    >
                                                        WhatsApp
                                                    </a>
                                                </div>
                                            </div>
                                        </div>
                                    ))}
                                </div>
                            )}
                        </div>
                    )}


                    <footer className="bg-gradient-to-br from-[#1a1a1a] to-[#761C1C] text-gray-300 py-16 px-4 mt-20">
                        <div className="container mx-auto text-center">
                            <h3 className="text-[#D4AF37] font-black text-3xl font-bebas mb-4">NACIÓN U CREMA</h3>
                            <p className="text-sm mb-8 max-w-2xl mx-auto">Productos oficiales con identidad crema. Calidad premium y envíos a todo el Perú.</p>
                            <div className="text-xs border-t border-gray-700 pt-8">© 2026 Nación U Crema. Todos los derechos reservados.</div>
                        </div>
                    </footer>

                    <a href="https://www.tiktok.com/@nacionucrema" target="_blank" rel="noopener noreferrer" className="fixed bottom-6 right-28 bg-black text-white p-5 rounded-full shadow-2xl hover:bg-gray-900 hover:scale-110 transition-all z-50 group" aria-label="TikTok Nación U Crema">
                        <TikTok className="h-8 w-8" />
                        <span className="pointer-events-none absolute bottom-full mb-3 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                            TikTok
                        </span>
                    </a>
                    <a href="https://wa.me/51937595257?text=Hola%20Nación%20U%20Crema" target="_blank" rel="noopener noreferrer" className="fixed bottom-6 right-6 bg-green-500 text-white p-5 rounded-full shadow-2xl hover:bg-green-600 hover:scale-110 transition-all z-50 group">
                        <WhatsAppLogo className="h-8 w-8" />
                        <span className="pointer-events-none absolute bottom-full mb-3 left-1/2 -translate-x-1/2 bg-gray-900 text-white px-4 py-2 rounded-lg font-bold whitespace-nowrap opacity-0 group-hover:opacity-100 transition-opacity">
                            Chatea con nosotros
                        </span>
                    </a>
                </div>
            );
        }

        ReactDOM.createRoot(document.getElementById('root')).render(<App />);
    </script>
</body>

</html>
